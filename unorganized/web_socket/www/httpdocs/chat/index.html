<!DOCTYPE html>
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script>
var server_url = 'ws://ec2-54-238-64-78.ap-northeast-1.compute.amazonaws.com:8484/chat';
// var server_url = 'ws://'+location.host+':8484/chat';
if (typeof WebSocket === 'undefined') {
    var ws = new MozWebSocket(server_url);
} else {
    var ws = new WebSocket(server_url);
}
    console.log(ws);

    $(function(){
        var addr = null;
        ws.onmessage = function (e) {
            if(e.target.url != server_url) return false;
            console.log(e);
            if (addr === null) {
                addr = e.data;
                $('#addr').html(addr + "さん");
            } else {
                if (e.data[0] === '@') {
                    $('#connections').text(e.data.substring(1));
                } else {
                    $('#chat').append('<p class="line ' + (e.data[0] === '>' ? 'mysay' : '') + '">' + e.data + '</p>');
                    $('#chat').scrollTop(99999);
                }
            }
        }

        ws.onopen = function (e) {
            $('#chat').append('<p class="line">チャットに参加しました。</p>').scrollTop(99999);
        }

        $('#form').submit(function(){
            ws.send($('#message').val());
            $('#message').val('');
            return false;
        });

        $('#close').click(function(){
            ws.close();
        });

    });
</script>
<style type="text/css">
    #chat {
        padding: 10px;
        height : 500px ;
        background: #eee;
        overflow : scroll ;
        overflow-x : hidden ;
    }

    #chat p {
        margin-bottom: 1em;
    }

    .line {
        color : #666666 ;
    }

    .mysay {
        font-weight : bolder ;
    }

</style>
</head>
<body>
<h1>WebSocket チャットサンプル</h1>
<form id="form" action="javascript:void(0);" method="post">

    <p id="addr">取得中...</p>
    <p>自分を含めて <span id="connections">0</span>人 参加中</p>

    <p><input type="text" id="message" value="" /><input type="submit" id="send" value="送信" /><input type="submit" id="close" value="切断" /></p>

    <div id="chat"></div>

</form>
</body>
</html>
