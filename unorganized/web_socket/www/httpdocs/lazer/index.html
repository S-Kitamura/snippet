<!DOCTYPE html>
<html>
<head>
<title></title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script>
// var server_url = 'ws://ec2-54-238-64-78.ap-northeast-1.compute.amazonaws.com:8484/lazer';
var server_url = 'ws://'+location.host+':8484/lazer';
if (typeof WebSocket === 'undefined') {
	var ws = new MozWebSocket(server_url);
} else {
	var ws = new WebSocket(server_url);
}

$(function(){
    var addr = null;
    var speed = 300;
    var type;
    ws.onmessage = function (e) {
        console.log(e);
    	if(e.target.url != server_url) return false;
        if (addr === null) {
            addr = e.data;
            $('#my').append('<div>'+addr+'さん</div>');
        } else {
            if (e.data[0] === '@') {
                $('#connections').text('参加者：'+e.data.substring(1));
            } else {
            	if(e.data.indexOf('[t]') > -1){
            		var html = e.data.split('[t]')[1];
					$('#field').append(html).find('.lazer').eq(-1).css({
						left: -200
					}).animate({
						left: win_w
					}, speed, 'linear', function(){
						$(this).remove();
					});
            	}
            }
        }
    }

    ws.onopen = function (e) {
        // console.log(e);
    }

    var win_w = $(window).width();
    var win_h = $(window).height();
    $(window).resize(function(){
        win_w = $(window).width();
        win_h = $(window).height();
    });
    var field_h = $('#field').height();

	var num = 0, html;
	$('#shot').click(function(){
		var style = 'top: '+Math.floor(Math.random()*field_h)+'px;';
			style += 'height: '+Math.floor(Math.random()*20)+'px;';
			style += 'background: rgba('+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+','+Math.floor(Math.random()*256)+','+(Math.floor(Math.random()*10)+1)/10+');';
			style += 'z-index: '+Math.floor(Math.random()*100)+';';
		$('#field').append('<div class="lazer" id="lazer'+num+'" style="'+style+'" />');
		$('#lazer'+num).animate({
			width: 200,
			left: win_w-200
		}, speed, 'linear', function(){
			html = $(this).wrap('<div />').parent().html();
			ws.send(html);
			$(this).animate({
				left: win_w*2
			}, speed, 'linear', function(){
				$(this).parent().remove();
			});
		});
		num++;
	});
});
</script>
<style type="text/css">
body {
	margin: 20px;
}
.lazer {
	width: 100px;
	position: absolute;
	top: 0;
	left: -100px;
}
#field {
	margin: 0 -20px;
	height: 300px;
	overflow: hidden;
	position: relative;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}
</style>
</head>
<body>
<h1>WebSocket レーザー</h1>
<div id="my"></div>
<div id="connections"></div>
<div id="menbers"></div>

<button id="shot">レーザー発射</button>

<div id="field"></div>

</body>
</html>
